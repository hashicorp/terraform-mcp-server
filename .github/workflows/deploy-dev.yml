name: Deploy to Dev

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy'
        required: false
        default: 'latest'
  workflow_run:
    workflows: ["build"]
    types:
      - completed
    branches:
      - main

env:
  CLUSTER_NAME: terraform-mcp-server-remote
  AWS_REGION: us-east-1
  HELM_RELEASE_NAME: terraform-mcp-server-remote

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy to Dev Environment
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      # TODO: Requires secret REMOTE_REPO_TOKEN
      # A GitHub PAT with access to the private hashicorp/terraform-mcp-server-remote repo
      - name: Checkout remote infra repo
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          repository: hashicorp/terraform-mcp-server-remote
          token: ${{ secrets.REMOTE_REPO_TOKEN }}
          path: infra

      # TODO: Requires secret AWS_ROLE_ARN (Open to a diff approach than below)
      # IAM role ARN that GitHub Actions can assume via OIDC for terraform_ai_ecosystem_dev account
      # Setup needed: 
      #   1. Create OIDC identity provider in AWS for GitHub Actions
      #   2. Create IAM role with EKS permissions that trusts the OIDC provider
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@ff717079ee2060e4bcee96c4779b553acc87447c
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name ${{ env.CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Determine image tag
        id: image-tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.image_tag }}"
          else
            TAG="${{ github.event.workflow_run.head_sha }}"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Deploying image tag: ${TAG}"

      - name: Deploy with Helm
        run: |
          helm upgrade --install ${{ env.HELM_RELEASE_NAME }} \
            ./infra/helm/terraform-mcp-server-remote \
            --set image.repository=hashicorppreview/terraform-mcp-server \
            --set image.tag=${{ steps.image-tag.outputs.tag }} \
            --wait \
            --timeout 5m

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/${{ env.HELM_RELEASE_NAME }} --timeout=3m
          echo "Deployment successful!"
          
      - name: Get service endpoint
        run: |
          echo "Service endpoint:"
          kubectl get ingress -o wide